{% extends "nominopolitan/daisyUI/base.html" %}
{% load static %}
{% load nominopolitan %}

{% block title %}{{ object_verbose_name_plural|title }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-base-content">{{ object_verbose_name_plural|title }}</h1>
        {% if can_create %}
            <a href="{% url 'create' %}" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Create {{ object_verbose_name }}
            </a>
        {% endif %}
    </div>

    <!-- Selection Status Container -->
    <div id="selection-status-container" 
         hx-get="{% url 'selection_status_view' model_name=model_name %}"
         hx-trigger="load, selection-updated from:body"
         hx-include="[name='preserved_params']"
         hx-target="#selection-status-container"
         hx-swap="outerHTML">
        {% include "nominopolitan/daisyUI/partial/selection_status.html" %}
    </div>

    <!-- Filter Form -->
    {% if filter_form %}
    <div class="mb-6">
        {% include "nominopolitan/daisyUI/partial/filter_form.html" %}
    </div>
    {% endif %}

    <!-- Bulk Actions Container -->
    <div id="bulk-actions-container" class="mb-4">
        {% if selected_count > 0 %}
            {% include "nominopolitan/daisyUI/partial/bulk_actions.html" %}
        {% endif %}
    </div>

    <!-- Object List Table -->
    <div class="overflow-x-auto">
        <table class="table table-zebra w-full">
            <thead>
                <tr>
                    {% if can_bulk_edit or can_bulk_delete %}
                    <th class="w-12">
                        <label class="cursor-pointer">
                            <input type="checkbox" 
                                   class="checkbox checkbox-sm"
                                   id="select-all-checkbox"
                                   hx-post="{% url 'toggle_all_selection_view' model_name=model_name %}"
                                   hx-target="#selection-status-container"
                                   hx-swap="outerHTML"
                                   hx-include="[name='preserved_params']"
                                   {% if selected_count == object_list|length %}checked{% endif %}>
                        </label>
                    </th>
                    {% endif %}
                    {% for column in columns %}
                    <th class="{% if column.sortable %}cursor-pointer{% endif %}">
                        {% if column.sortable %}
                            <a href="{% url 'list' %}{{ preserved_params }}&sort={{ column.name }}{% if sort == column.name and direction == 'asc' %}&direction=desc{% else %}&direction=asc{% endif %}"
                               class="flex items-center">
                                {{ column.label }}
                                {% if sort == column.name %}
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        {% if direction == 'asc' %}
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                        {% else %}
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                        {% endif %}
                                    </svg>
                                {% endif %}
                            </a>
                        {% else %}
                            {{ column.label }}
                        {% endif %}
                    </th>
                    {% endfor %}
                    <th class="w-24">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for object in object_list %}
                <tr>
                    {% if can_bulk_edit or can_bulk_delete %}
                    <td>
                        <label class="cursor-pointer">
                            <input type="checkbox" 
                                   class="checkbox checkbox-sm row-checkbox"
                                   value="{{ object.pk }}"
                                   hx-post="{% url 'toggle_selection_view' model_name=model_name %}"
                                   hx-target="#selection-status-container"
                                   hx-swap="outerHTML"
                                   hx-include="[name='preserved_params']"
                                   {% if object.pk in selected_ids %}checked{% endif %}>
                        </label>
                    </td>
                    {% endif %}
                    {% for column in columns %}
                    <td>
                        {% if column.name == 'action_links' %}
                            {% action_links object %}
                        {% else %}
                            {{ column.render|default:object|getattr:column.name }}
                        {% endif %}
                    </td>
                    {% endfor %}
                    <td>
                        <div class="flex space-x-1">
                            {% action_links object %}
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="{{ columns|length|add:2 }}" class="text-center py-8">
                        <div class="text-base-content/70">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <p>No {{ object_verbose_name_plural }} found.</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
    <div class="mt-6">
        {% include "nominopolitan/daisyUI/partial/pagination.html" %}
    </div>
    {% endif %}
</div>

<!-- Hidden preserved parameters for HTMX requests -->
<script>
    // Store preserved parameters for HTMX requests
    window.preservedParams = '{{ preserved_params|default:'' }}';
</script>

<!-- JavaScript fallback for non-HTMX scenarios -->
<script>
    // Fallback JavaScript for backward compatibility
    document.addEventListener('DOMContentLoaded', function() {
        // Only initialize if HTMX is not available
        if (typeof htmx === 'undefined') {
            // Initialize legacy selection handling
            initializeLegacySelection();
        }
    });

    function initializeLegacySelection() {
        // Legacy selection handling code
        console.log('Legacy selection mode enabled');
    }
</script>
{% endblock %}
